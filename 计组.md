计算机组成原理

## 计算机系统概述

### 计算机发展历程

![image-20230709163805234](计组.assets/image-20230709163805234.png)

### 计算机系统层次结构

##### 计算机系统的组成

一个完整的计算机系统包括配套的硬件系统和软件系统。

- 冯诺依曼体系结构：以**运算器**为核心

![image-20220812212521794](计组.assets/image-20220812212521794.png)

- 冯诺依曼体系结构的特点

![image-20230709164107467](计组.assets/image-20230709164107467.png)

输入输出设备与存储器之间的数据传送通过运算器完成。

**存储程序原理：**存储程序是指将指令以代码的形式事先输入计算机主存储器，然后按其在存储器中的首地址执行程序的第一条指令，以后就按该程序的规定顺序执行其他指令，直至程序执行结束。

- 现在计算机体系结构：以存储器为中心

![image-20230709164146951](计组.assets/image-20230709164146951.png)

​    CPU=运算器+控制器

- CPU，主机，外设

![image-20230709164205952](计组.assets/image-20230709164205952.png)

##### 计算机硬件

1. 存储器

   主存储器由存储体，MAR，MDR组成

   和右边的图进行类比，MAR存储CPU想要获取数据的地址，在存储体中找到后放在MDR中，CPU从MDR中把数据取走。

   ![image-20230709164423568](计组.assets/image-20230709164423568.png)

   存储体是由一个个存储单元组成的

   存储字：存储单元中二进制代码的集合

   存储字长：存储单元中二进制代码的位数

   ![image-20230709164437273](计组.assets/image-20230709164437273.png)

2. 运算器

   ![image-20230709164450504](计组.assets/image-20230709164450504.png)

3. 控制器

   ![image-20230709164500333](计组.assets/image-20230709164500333.png)

##### 计算机系统的工作原理

- 程序被编译成二进制存储在主存中

![image-20230709164805559](计组.assets/image-20230709164805559.png)

>工作过程

- （MAR）=0：表示MAR里边的值为0

- M(MAR) ：主存储器所指向的存储单元里边的值
- OP（IR）：取操作码
- Ad（IR）：取地址码

![image-20230709165056480](计组.assets/image-20230709165056480.png)

![image-20230709165036837](计组.assets/image-20230709165036837.png)

![image-20220812220003294](计组.assets/image-20220812220003294.png)

![image-20220812220123356](计组.assets/image-20220812220123356.png)

![image-20220812220152847](计组.assets/image-20220812220152847.png)

![image-20220812220255227](计组.assets/image-20220812220255227.png)

##### 计算机的层次结构

![image-20230709165216662](计组.assets/image-20230709165216662.png)

- 注意编译程序和解释程序的区别
  - 编译程序:   将高级语言编写的源程序全部语句一次全部翻译成机器语言程序，而后再执行机器语言程序（只需翻译一次)
  - 解释程序：将源程序的一条语句翻译成对应于机器语言的语句，并立即执行。紧接着再翻译下一句(每次执行都要翻译)
  - 汇编程序：将汇编语言程序翻译成机器语言程序。

![image-20230709165235904](计组.assets/image-20230709165235904.png)

##### 习题笔记

- 冯诺依曼机的基本工作方式：控制流驱动方式。

- 冯诺依曼机是单处理机。

- 软件和硬件具有逻辑上的等效性，硬件实现具有更高的执行速度，软件实现具有更好的灵活性。执行频繁、硬件实现代价不是很高的功能通常由硬件实现。

- 在运算器中，不包含**地址寄存器**。

- 把汇编语言源程序转变为机器语言程序的过程是**汇编**。

- 数据库系统**不是**系统软件，数据库管理系统是系统软件。

- **相联存储器**既可以按地址寻址也可按内容寻址。

- 指令和数据都以二进制形式存储在存储器中，CPU区分它们的依据是：指令周期的不同阶段。

  解析：在取值阶段取的是指令，执行阶段取的是数据。容易选成 指令操作码的译码结果，需要注意的是，CPU只有在确定取出的是指令时，才会将其操作码送去译码。

- 计算机硬件能够直接执行的是**机器语言**。

### 计算机的性能指标

##### 存储器

![image-20230709170509138](计组.assets/image-20230709170509138.png)

##### CPU

CPU主频：CPU内数字脉冲信号振荡的频率。

![image-20230709170520627](计组.assets/image-20230709170520627.png)

CPU执行时间（整个程序的耗时）

##### 系统整体的性能指标

![image-20230709170533857](计组.assets/image-20230709170533857.png)

基准程序：是用来测量计算机处理速度的一种实用程序，以便于被测量的计算机性能可以与运行相同程序的其他计算机性能进行比较。（跑分软件）

##### 思考

![image-20220813170931396](计组.assets/image-20220813170931396.png)

##### 习题笔记

- ![image-20220813171100121](计组.assets/image-20220813171100121.png)

- 存储字长是指存放在一个存储单元中的二进制代码位数。

  数据字长是数据总线一次能并行传送信息的位数，可以不等于MDR的位数。

  机器字长是指计算机一次能处理的二进制数的长度。

- 用于科学计算的计算机中，标志系统性能的最有用的参数是**MFLOPS**（每秒执行多少百万次浮点运算，用来描述计算机的浮点运算性能）。

- 在CPU的寄存器中，指令寄存器（IR）、地址寄存器（MAR）、数据寄存器（MDR）对用户是完全透明（不可见）的。

- CPU周期又称机器周期，它由多个时钟周期组成。

- CPU 的 CPI 与**时钟频率**无关，与**系统结构，计算机组织，指令集**有关。

- 从用户观点看，评价计算机系统性能的综合参数是**吞吐率**。吞吐率指系统在单位时间内处理请求的数量。

- 提高CPU主频、扩大主存容量对性能的提升是有限度的。**采用并行技术**是实现高性能计算的重要途径，现今超级计算机均采用**多处理器**来增强并行处理能力。

- 兼容指计算机软件或硬件的通用性，兼容通常在同一系列的不同型号计算机间。

- 计算机“运算速度”指标的含义是每秒能执行多少条指令。

- CPU概念：利用大规模集成电路技术把计算机的运算部件和控制部件做在一块集成电路芯片上，这样的一块芯片称为CPU。

- 能够缩短程序执行时间的措施：

  - 提高CPU时钟频率：主频越高，完成指令的一个执行步骤用时就短，执行指令速度就越快。

  - 优化数据通路结构：有效地提高计算机系统的吞吐量，加快程序执行。

    （数据通路的功能是实现CPU内部的运算器和寄存器及寄存器之间的数据交换）

  - 对程序进行编译优化

- IPC是CPI的倒数，即每个时钟周期执行的指令数。

  MIPS是每秒执行多少百万条指令，适用于衡量标量机的性能。

  MFLOPS是每秒执行多少百万条浮点数运算，适用于衡量向量机的性能。

- **ALU和通用寄存器**的位数一定与机器字长相同。

> 各种关系的转换

- MIPS = 时钟频率/CPI

- 程序执行时间 = CPI * 时钟周期 * 指令数
- 指令周期 = 1 / 指令执行速度
- 微机逻辑电路相同，指的是 CPI 相同， 时钟周期不一定相同。

## 数据的表示和运算

### 数制与编码

##### 进位计数制及其相互转换

- 任意进制转十进制

  ![image-20220816201027321](计组.assets/image-20220816201027321.png)

  ![image-20220816201256893](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20220816201256893.png)

- 二进制<——> 八进制，十六进制  (注意：小数部分也是从右往左算)

  ![image-20230718194951012](计组.assets/image-20230718194951012.png)

  各种进制常见的书写方式

  ![image-20220816201730003](计组.assets/image-20220816201730003.png)

- 十进制转任意进制（整数部分）

  ![image-20230718195010490](计组.assets/image-20230718195010490.png)

- 十进制转任意进制（小数部分）

  ![image-20230718195027461](计组.assets/image-20230718195027461.png)

- 十进制转二进制（拼凑法，适用于十进制数不是很大的情况）

  ![image-20230718195041556](计组.assets/image-20230718195041556.png)

- 真值和机器数

  ![image-20230718195052823](计组.assets/image-20230718195052823.png)

##### BCD码*（大纲已删除）

- 概念

  ![image-20230718195104355](计组.assets/image-20230718195104355.png)

- 8421码

  ![image-20230718195113140](计组.assets/image-20230718195113140.png)

- 8421码相加

1. 可以转换成十进制相加后，再转换成8421码
2. 机算方法：不在范围内，加6。如图所示

![image-20230718195133116](计组.assets/image-20230718195133116.png)

- 其他表示方式

![image-20230718195142554](计组.assets/image-20230718195142554.png)

##### 整数的表示和运算

1. 无符号整数的表示和运算

   ![image-20220816205649810](计组.assets/image-20220816205649810.png)

2. 带符号整数的表示和运算

   - 原码

     原码的缺点：符号位不能参与运算，需要设计复杂的硬件电路才能处理，费钱。

     原码→反码→补码的转换

     ![image-20220816210548401](计组.assets/image-20220816210548401.png)

     原码、补码快速转换技巧

     ![image-20220816210939621](计组.assets/image-20220816210939621.png)

   - 补码的加法运算

     ![image-20220816211248831](计组.assets/image-20220816211248831.png)

   - 补码的减法运算

     > 加法电路造价便宜，减法电路造价昂贵。减法变加法则可省钱。

     ![image-20220816211917035](计组.assets/image-20220816211917035.png)

   - 溢出判断

     ![image-20230718195200174](计组.assets/image-20230718195200174.png)

   - 移码

     移码：补码的基础上将符号位取反。注意：移码只能用于表示整数。

   - 总结

     计算机内部，所有带符号整数的加减法都要先转化为补码。
   
     原反补移码的转换
   
     ![image-20220816213031749](计组.assets/image-20220816213031749.png)

##### 原反补移码的特性对比

![image-20220816213318781](计组.assets/image-20220816213318781.png)

常见考点：两个数A和B进行某种运算后，是否发生溢出？---手算做题可以带入十进制验证，是否超出合法范围。

##### 定点小数的表示和运算

1. 定点小数原反补码的转换

   ![image-20220816214013518](计组.assets/image-20220816214013518.png)

2. 定点小数的加减运算

   ![image-20220816214108593](计组.assets/image-20220816214108593.png)

3. 定点整数VS定点小数

   ![image-20220816214203511](计组.assets/image-20220816214203511.png)

##### 习题笔记

- 一般用移码表示浮点数的阶，而补码表示定点整数。
- 可用无符号整数进行地址运算，或用它来表示指针。
- 在计算机中，通常用来表示主存地址的是无符号数。
- 使用补码表示时，若符号位相同，则数值位越大码值越大。

### 运算方法和运算电路

##### 电路的基本原理

- 基本的逻辑运算

![image-20230718195220530](计组.assets/image-20230718195220530.png)

- 复合逻辑

![image-20230718195233109](计组.assets/image-20230718195233109.png)

##### 基本运算部件

在计算机中，运算器由算术逻辑单元（ALU）、移位器、状态寄存器和通用寄存器组等组成。运算器的基本功能包括加减乘除四则运算，与、或、非、异或等逻辑运算，以及移位、求补等操作。ALU的核心部件是加法器。

1. 一位全加器

   ![image-20220816225840260](计组.assets/image-20220816225840260.png)

2. 串行加法器

   ![image-20220816230035785](计组.assets/image-20220816230035785.png)

   一位全加器+进位触发器，只能一位一位地加。

3. 并行加法器

   ![image-20220816230434377](计组.assets/image-20220816230434377.png)

   - 多个全加器简单串联，可多位同时加
   - 计算速度取决于进位产生和传递的速度

4. 并行进位加法器

   ![image-20220816235337599](计组.assets/image-20220816235337599.png)

5. 补码加减运算器

   ![image-20220817203826418](计组.assets/image-20220817203826418.png)

   无符号数的加减运算器

   ![image-20220817203907141](计组.assets/image-20220817203907141.png)

##### 标志位的生成 

![image-20220817204917343](计组.assets/image-20220817204917343.png)

![image-20220817204958123](计组.assets/image-20220817204958123.png)

##### 定点数的移位运算 

1. 算术移位

   算术移位的对象是有符号数，在移位过程中符号位保持不变。

   - 原码的算术移位

     ![image-20230718195256066](计组.assets/image-20230718195256066.png)

   - 反码的算术移位

     ![image-20230718195308368](计组.assets/image-20230718195308368.png)

   - 补码的算术移位

     ![image-20230718195342651](计组.assets/image-20230718195342651.png)

   - 总结

     ![image-20230718195353121](计组.assets/image-20230718195353121.png)

2. 逻辑移位

   ![image-20230718195405405](计组.assets/image-20230718195405405.png)

3. 循环移位

   ![image-20220817210241031](计组.assets/image-20220817210241031.png)

##### 定点数的乘除运算

1. 原码的乘法运算

   - 机器实现

     ![image-20230718195420266](计组.assets/image-20230718195420266.png)

   - 手算模拟

     ![image-20220817222659875](计组.assets/image-20220817222659875.png)

2. 补码的乘法运算

   - 机器实现

     ![image-20230718195433776](计组.assets/image-20230718195433776.png)

   - 手算模拟

     ![image-20230718195446582](计组.assets/image-20230718195446582.png)

3. 原码的除法运算

   - 手算除法

     ![image-20220817224343846](计组.assets/image-20220817224343846.png)

   - 恢复余数法

     ![image-20220817225153526](计组.assets/image-20220817225153526.png)

     ![image-20220817225221503](计组.assets/image-20220817225221503.png)

     ![image-20220817225249944](计组.assets/image-20220817225249944.png)

     ![image-20220817225324663](计组.assets/image-20220817225324663.png)

     ![image-20220817225341122](计组.assets/image-20220817225341122.png)

   - 加减交替法（不恢复余数法）

     ![image-20220817230418908](计组.assets/image-20220817230418908.png)

     ![image-20220817230550519](计组.assets/image-20220817230550519.png)

4. 补码的除法运算

   ![image-20230718195524037](计组.assets/image-20230718195524037.png)

   ![image-20220817231212792](计组.assets/image-20220817231212792.png)


##### C语言中的整数类型及类型转换

![image-20230718195535090](计组.assets/image-20230718195535090.png)

![image-20230815165754190](计组.assets/image-20230815165754190.png)

##### 数据的存储和排列

- 大小端模式

  ![image-20230718195544297](计组.assets/image-20230718195544297.png)

  大端方式：一个字中的高位字节存放在内存中这个字区域的低地址处。

  小端方式：一个字中的低位字节存放在内存中这个字区域的低地址处。

- 边界对齐

  ![image-20230718195600808](计组.assets/image-20230718195600808.png)

##### 习题笔记

- ALU属于**组合逻辑电路**。

- 在串行进位的并行加法器中，影响加法器运算速度的关键因素是**进位传递延迟**。

- 加法器中每位的进位信号为 **XY**，进位传递信号**X⊕Y**。

- 模4补码（即双符号位）存储时**只需要一个符号位**，因为一个正确的数值，两个符号位是相同的。只在ALU中采用双符号位。

- 补码一位乘法中，最多需要n次右移，n+1次加法运算。

  原码一位乘法中，移位和加法运算最多均为n次。

- 实现N位（不包含符号位）补码一位乘时，乘积为**2N+1**位。

- 在算术移位的情况下，补码左移的前提条件是**其原最高有效位和原符号位要相同**。

- 在算术移位的情况下，双符号位的移位操作只有低符号位需要参加移位操作。

- C语言中变量都以**补码**形式存储，int 四字节，short 两字节，char 一字节

- 无符号数FFFFH=65535，$2^{16}=65536,2^{15}=32768$。

- ![image-20230815175219776](计组.assets/image-20230815175219776.png)

### 浮点数的表示与运算

##### 浮点数的表示

- 浮点数的表示

![image-20230718195618188](计组.assets/image-20230718195618188.png)

- 尾数的规格化

![image-20230718195626281](计组.assets/image-20230718195626281.png)

##### IEEE 754 浮点数标准

- 标准

![image-20230718195638512](计组.assets/image-20230718195638512-17313141142901.png)

![image-20220822210109427](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20220822210109427.png)

- 示例（十进制转换为浮点数）

![image-20230718195649767](计组.assets/image-20230718195649767.png)

- 示例（浮点数转换为十进制数）

![image-20230718195657829](计组.assets/image-20230718195657829.png)

- 单精度浮点数表示的最大值，最小值

![image-20230718195710157](计组.assets/image-20230718195710157.png)

- 特殊数值 

![image-20230718195720901](计组.assets/image-20230718195720901.png)

##### 浮点数的运算

- 和十进制的科学计数法进行类比

![image-20230718195733392](计组.assets/image-20230718195733392.png)

- 浮点数加减法

![image-20230718195744549](计组.assets/image-20230718195744549.png)

- 舍入

![image-20230718195757029](计组.assets/image-20230718195757029.png)

- 强制类型转换

![image-20230718195813627](计组.assets/image-20230718195813627.png)

##### 习题笔记

- 在浮点数总位数不变的情况下，阶码位数越多，尾数位数越少；即表示的数的范围越大，精度越差（数变稀疏）。![image-20230720113858299](计组.assets/image-20230720113858299.png)

  E位数多则范围大，M位数多则精度高。

- 基数越大，在运算中尾数右移的可能性越小，运算的精度损失越小。

  由于基数大时发生因对阶或尾数溢出需右移及规格化需左移的次数显著减少，因此运算速度可以提高。

  基数越大，可表示的数的范围越大。

- 在对阶操作中，不存在阶码减小，位数左移的情况。因为阶码小的要向阶码大的对齐。

- 采用规格化的浮点数最主要是为了增加数据的表示精度。

- 在计算机中，表示的数有时会发生溢出，根本原因是计算机的字长有限。

- 8421码是十进制数的编码。

- 补码的规格化表示是小数点后一位与符号位不同。

  原码的规格化表示是小数点后一位为1。

- 定点数没有舍入的概念，只有浮点数才有。

- 浮点数舍入的情况有两种：1. 对阶 。 2. 右规格化。

- 舍入不一定产生误差。

- 尾数溢出时，可能只产生误差，结果不一定溢出。

- 对阶操作不会引起阶码上溢或下溢。

- ![image-20221102171410772](计组.assets/image-20221102171410772.png)

  ![image-20221102174517205](计组.assets/image-20221102174517205.png)

## 存储系统

##### 存储器的分类

1. 层次

   ![image-20241111163800618](计组.assets/image-20241111163800618.png)

2. 存储介质

   ![image-20241111163812725](计组.assets/image-20241111163812725.png)

3. 存取方式

   ![image-20241111163823669](计组.assets/image-20241111163823669.png)

4. 信息可更改性

   ![image-20241111163838767](计组.assets/image-20241111163838767.png)

5. 信息的可保持性

   ![image-20241111163850128](计组.assets/image-20241111163850128.png)

### 存储器概述

##### 存储器的性能指标

![image-20241111163736065](计组.assets/image-20241111163736065.png)

##### 多级层次的存储系统

![image-20241111163724133](计组.assets/image-20241111163724133.png)

##### 习题笔记

- 磁盘属于直接存取存储器（DAM），其速度介于随机存取存储器（RAM）和顺序存取存储器（SAM）之间。

- 存储器的存取周期是指存储器进行连续读或写操作所允许的最短时间间隔。

- 相联存储器（CAM）是按**内容指定方式和地址指定方式相结合**进行寻址的存储器。

- CPU不能直接访问硬盘，需先将硬盘中的数据调入内存才能被CPU访问。

- 计算机的存储器采用分级方式是为了解决容量、速度、价格三者之间的矛盾。

- 计算机的存储系统包括CPU内部寄存器、Cache、主存和外存。

- 多级存储系统是为了**降低存储成本**。

- 虚拟存储器中主存和辅存之间的数据调动对**应用级程序员**是透明的。

- 随机存取是指CPU可对存储器的任一存储单元中的内容随机存取，而且存取时间与存储单元的物理位置无关。

  CD-ROM即光盘，采用串行存取方式。是只读型光盘存储器，其访问方式是顺序访问。
  
- Cache主存系统的效率=访问Cache的时间/平均访存时间。

### 主存储器

##### 主存储器的基本组成

- 存储器芯片的基本结构

![image-20241111163916428](计组.assets/image-20241111163916428.png)

![image-20241111163927164](计组.assets/image-20241111163927164.png)

- 寻址

![image-20241111163940357](计组.assets/image-20241111163940357.png)

![image-20241111163951148](计组.assets/image-20241111163951148.png)

##### SRAM芯片和DRAM芯片

- 两种RAM的比较

  ![image-20220828224026742](计组.assets/image-20220828224026742.png)

  - DRAM芯片：使用栅极电容存储信息

    SRAM芯片：使用双稳态触发器存储信息

    核心区别是：存储元不一样

  - 栅极电容vs双稳态触发器

    - ![image-20220828224329703](计组.assets/image-20220828224329703.png)
    - ![image-20220828224351993](计组.assets/image-20220828224351993.png)
    - ![image-20241111164018766](计组.assets/image-20241111164018766.png)

  - ![image-20241111164133009](计组.assets/image-20241111164133009.png)

- DRAM的刷新

  ![image-20230718195912377](计组.assets/image-20230718195912377.png)
  
  ![image-20220828223753216](计组.assets/image-20220828223753216-17313144991452.png)
  
  一次完整的刷新过程只需要占用一个存储周期。

##### ROM（只读存储器）

RAM芯片--易失性，断电后数据消失

ROM芯片--非易失性，断电后数据不会丢失

1. 各种ROM

   ![image-20220828225515867](计组.assets/image-20220828225515867.png)

2. 计算机内的重要ROM

   ![image-20220828225720314](计组.assets/image-20220828225720314.png)

   ![image-20220828225736639](计组.assets/image-20220828225736639.png)

![image-20220828225815081](计组.assets/image-20220828225815081-17313145082133.png)

##### 多模块存储器

1. 双端口RAM

   ![image-20220829215037382](计组.assets/image-20220829215037382.png)

2. 单体多字存储器

   ![image-20220829215837226](计组.assets/image-20220829215837226.png)

3. 多体并行存储器

   - 高位交叉编址（顺序方式）

     高位地址表示体号，低位地址为体内地址。

   - 低位交叉编址（交叉方式）

     低位地址为体号，高位地址为体内地址。

   ![image-20220829215348469](计组.assets/image-20220829215348469.png)

   ![image-20220829215537301](计组.assets/image-20220829215537301.png)

   ![image-20220829215744681](计组.assets/image-20220829215744681.png)

##### 习题笔记

- 芯片的引脚数除了数据线和地址线，还有**一根片选线和读写控制线**（一根和两根都有可能）。

- DRAM的刷新是以**行**为单位的。

-  DRAM在**分散刷新**时，不存在死时间。集中刷新的死时间大于异步刷新。

- 采用地址复用技术时，数据线减半，但会多增加行通选线和列通选线（片选线用行通选代替）。

- Cache是易失性存储器，falsh存储器不是易失性存储器

- U盘属于只读存储器。

- 随机存取与随机存取存储器（RAM）不同，只读存储器（ROM）也是随机存取的。支持随机存取的存储器不一定是RAM。

- RAM和ROM都是采用**随机存取方式**进行信息访问。

- 因计算机的操作系统保存在硬盘上，所以需要BIOS的引导程序将操作系统引导到主存（RAM）中，而引导程序则固化于ROM中。

- 闪存：读速度比写快；是一种半导体存储器；非易失性存储器；随机访问方式。

- 高位交叉存储器在单个存储器中的字是连续存放的，不满足程序的局部性原理

  低位交叉存储器是交叉存放，很好地满足了程序的局部性原理。

- 双端口存储器具有两套独立读/写口，具有各自的地址寄存器和译码电路，可以同时访问同一区间、同一单元。

- 当两个端口同时对相同的单元进行读操作时，则不会发生冲突。

### 主存储器与CPU的连接

![image-20220829213443728](计组.assets/image-20220829213443728.png)

![image-20220829213520552](计组.assets/image-20220829213520552.png)

##### 主存容量的扩展

1. 位扩展

   ![image-20220829213607638](计组.assets/image-20220829213607638.png)

   ![image-20220829213643179](计组.assets/image-20220829213643179.png)

2. 字扩展

   - 线选法

     ![image-20220829213722321](计组.assets/image-20220829213722321.png)

   - 片选法

     ![image-20220829213836785](计组.assets/image-20220829213836785.png)

     - CS：片选线（决定主存是否工作）这种写法是高电平有效
     - WE：读写控制线
     - A0~A13：地址线
     - D0~D7：数据线 

   - 线选法和译码线选法的区别

     ![image-20220829214019655](计组.assets/image-20220829214019655.png)

3. 字位同时扩展法

   ![image-20220829214114029](计组.assets/image-20220829214114029.png)

4. 译码器

   ![image-20220829214200317](计组.assets/image-20220829214200317.png)

   ![image-20220829214225922](计组.assets/image-20220829214225922.png)

##### 习题笔记

### 外部存储器

计算机的外存储器又称为辅助存储器，目前主要使用磁表面存储器。

磁盘存储器、磁带存储器和磁鼓存储器都属于磁表面存储器。

外存储器既可以作为输入设备，也可以作为输出设备（既可以存数据，也可以读数据）

##### 磁盘存储器

优缺点：

- 优点：
  - 存储容量大，位价格低
  - 记录介质可重复使用
  - 记录信息可长期保存而不丢失，甚至可以脱机存档
  - 非破坏性读出，读出时不需要再生
- 缺点：
  - 存取速度慢
  - 机械结构复杂
  - 对工作环境要求较高

1. 磁盘设备的组成

   存储区域

   一块硬盘含有若干个记录面，每个记录面划分为若干磁道，而每条磁道又划分为若干个扇区，扇区（也称块）是磁盘读写的最小单位，也就是说磁盘按块存取。

   - 磁头数

     即记录面数，表示硬盘总共有多少个磁头，磁头用于读取/写入盘片上记录面的信息，一个记录面对应一个磁头。

   - 柱面数

     表示硬盘每一面盘片上有多少条磁道。在一个盘组中，不同记录面的相同编号（位置）的诸磁道构成一个圆柱面。

   - 扇区数

     表示每条磁道上有多少个扇区

   磁盘存储器的组成

   磁盘存储器由磁盘驱动器、磁盘控制器和盘片组成。

   - 磁盘驱动器

     核心部件是磁头组件和盘片组件，温彻斯特盘是一种可移动磁头固定盘片的硬盘存储器。

   - 磁盘控制器

     是硬盘存储器和主机的接口，主流的标准有IDE、SCSI、SATA等。

2. 磁盘的性能指标

   ![image-20220905185145095](计组.assets/image-20220905185145095.png)

   ![image-20220905185232844](计组.assets/image-20220905185232844.png)

3. 磁盘地址

   ![image-20220905185501477](计组.assets/image-20220905185501477.png)

4. 硬盘的工作过程

   硬盘的主要操作是寻址、读盘、写盘。每个操作都对应一个控制字，硬盘工作时，第一步是取控制字，第二步是执行控制字。

   硬盘属于机械式部件，其读写操作是**串行的**，不可能在同一时刻既读又写，也不可能在同一时刻读两组数据或写两组数据。

5. 磁盘阵列

   ![image-20220905191110268](计组.assets/image-20220905191110268.png)

   ![image-20220905191143330](计组.assets/image-20220905191143330.png)

   ![image-20220905191202726](计组.assets/image-20220905191202726.png)

   RAID2~5：通过数据校验提高容错能力

   RAID通过同时使用多个磁盘，提高了传输率；通过在多个磁盘上并行存取来大幅提高存储系统的数据吞吐量；通过镜像功能，可以提高安全可靠性；通过数据校验，可以提供容错能力。

##### 固态硬盘

SSD是一种基于闪存技术的存储器。

![image-20220905204435430](计组.assets/image-20220905204435430.png)

##### 习题笔记

- RAID技术不可以提高磁盘的磁记录密度和磁盘利用率。
- 固态硬盘（SSD）**容易磨损**。
- 未格式化的硬盘容量要大于格式化后的实际容量。
- 用于提高RAID可靠性的措施有：磁盘镜像、奇偶校验。
- 磁盘扇区中包含数据、地址和校验等信息。
- 磁盘平均存取时间：访道时间 + 访问扇区时间 + 扫描扇区时间
- 存取一个扇区的平均延迟时间为旋转半周的时间。

### 高速缓冲存储器（Cache）

##### 程序访问的局部性原理 

- 局部性原理

  ![image-20220908211449910](计组.assets/image-20220908211449910.png)

- 性能分析

  ![image-20220908212349284](计组.assets/image-20220908212349284.png)

- 例题

  ![image-20220908212614753](计组.assets/image-20220908212614753.png)

- 有待解决的问题

  ![image-20220908213442209](计组.assets/image-20220908213442209.png)

  ![image-20220908213645331](计组.assets/image-20220908213645331.png)

##### Cache的基本工作原理

Cache被集成在CPU内部Cache用SRAM实现，速度快，成本高。

当CPU发出读请求时，若访存地址在Cache中命中，就将此地址转换成Cache地址，直接对Cache进行读操作，与主存无关；若Cache不命中，则仍需访问主存，并把此字所在的块一次性地从主存调入Cache。若此时Cache已满，则需根据某种替换算法，用这个块替换Cache中原来的某块信息。整个过程全部由硬件实现。

**CPU与Cache之间的数据交换以字为单位，而Cache与主存之间的数据交换则以Cache块为单位。**

![image-20230722110345197](计组.assets/image-20230722110345197.png)

##### Cache和主存的映射方式

![image-20220908215137741](计组.assets/image-20220908215137741.png)

1. 全相联映射（随意放）

   ![image-20220908215521755](计组.assets/image-20220908215521755.png)

   ![image-20220908215713231](计组.assets/image-20220908215713231.png)

2. 直接映射（只能放固定位置）

   ![image-20220908220042239](计组.assets/image-20220908220042239.png) 

   ![image-20220908220149380](计组.assets/image-20220908220149380.png)

3. 组相联映射(可放到特定分组)

   ![image-20220908220429718](计组.assets/image-20220908220429718.png)

4. 各自优缺点

   | 映射方式   | 优点                                           | 缺点                                       |
   | ---------- | ---------------------------------------------- | ------------------------------------------ |
   | 全相联映射 | Cache存储空间利用充分，命中率高                | 查找“标记”最慢，有可能需要对比所有行的标记 |
   | 直接映射   | 对于任意一个地址，只需对比一个“标记”，速度最快 | Cache存储空间利用不充分，命中率低          |
   | 组相联映射 | 前两种方式的折中，综合效果较好                 |                                            |

##### Cache中主存块的替换算法

![image-20220908225337680](计组.assets/image-20220908225337680.png)

1. 随机算法（RAND）

   ![image-20220908225541655](计组.assets/image-20220908225541655.png)

2. 先进先出算法（FIFO）

   ![image-20220908225811521](计组.assets/image-20220908225811521.png)

3. 近期最少使用算法（LRU）

   ![image-20220908230546972](计组.assets/image-20220908230546972.png)

   ![image-20220908230614024](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20220908230614024.png)

   若被频繁访问的主存快数量>Cache行的数量，则有可能发生“抖动”，如：{1,2,3,4,5,1,2,3,4,5,1,2...}

4. 最不经常使用算法（LFU）

   ![image-20220908231126978](计组.assets/image-20220908231126978.png)

   ![image-20220908231259921](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20220908231259921.png)

   LRU侧重于近期表现，LFU侧重于全局表现

##### Cache写策略

> 为什么不讨论读命中、读不命中的情况？

读操作不会导致Cache和主存的数据不一致。

1. 写命中

   - 写回法

     脏位（修改位 ）：用来表示对应Cache行中的块是否被修改过。

     ![image-20220908233003476](计组.assets/image-20220908233003476.png)

   - 全写法（写直通法）

      缺点是增加了访存次数，降低了Cache的效率。

     写缓冲：为减少全写法直接写入主存的时间损耗，在Cache和主存之间加一个写缓冲。CPU同时写数据到Cache和写缓冲中，写缓冲再控制将内容写入主存。

     ![image-20220908233131958](计组.assets/image-20220908233131958.png)

2. 写不命中

   - 写分配法

     当CPU对Cache写不命中时，把主存中的块调入Cache，在Cache中修改。通常**搭配写回法**使用。

   - 非写分配法

     当CPU对Cache写不命中时，只写入主存，不调入Cache。通常**搭配全写法**使用。

3. 多级Cache

   现代计算机常采用多级Cache。离CPU越近的速度越快，容量越小。离CPU越远的速度越慢，容量越大。

   ![image-20220908234120746](计组.assets/image-20220908234120746.png)

##### 习题笔记

- 当CPU访存时，先要到Cache中查看该主存地址是否在Cache中，所以发送的主存物理地址。只有在虚拟存储器中，CPU发出的才是虚拟地址。

- 采用指令Cache与数据Cache分离的主要目的是**减少指令流水线资源冲突**。因为分离之后，取指令和取数据分别到不同的Cache中寻找，则指令流水线中取指部分和取数部分就可以很好地避免冲突。

- 时间局部性：一旦一条指令执行，它就可能在不久的将来再被执行。

  空间局部性：一旦一个存储单元被访问，它附近的存储单元也很快被访问。
  
- ![image-20221107231319286](计组.assets/image-20221107231319286.png)

### 虚拟存储器

##### 页式存储

![image-20220909214556198](计组.assets/image-20220909214556198.png)

##### 虚拟存储器的基本概念

![image-20220909214353955](计组.assets/image-20220909214353955.png)

![image-20220909214436805](计组.assets/image-20220909214436805.png)

##### 页式虚拟存储器

![image-20220909214241988](计组.assets/image-20220909214241988.png)

![image-20220909214224189](计组.assets/image-20220909214224189.png)

![image-20220909214212568](计组.assets/image-20220909214212568.png)

##### 段式虚拟存储器  

![image-20220909214133573](计组.assets/image-20220909214133573.png)

![image-20220909214149066](计组.assets/image-20220909214149066.png)

##### 段页式虚拟存储器

![image-20220909214104396](计组.assets/image-20220909214104396.png)

##### 虚拟存储器与Cache的比较

1. 相同点
   - 最终目标都是为了提高系统性能，两者都有容量、速度、价格的梯度。
   - 都把数据划分为小信息块，并作为基本的传递单位，虚存系统的信息块更大。
   - 都有地址的映射、替换算法、更新策略等问题。
   - 依据程序的局部性原理应用“快速缓存的思想”，将活跃的数据放在相对高速的部件中。
2. 不同点
   - Cache主要解决系统速度，而虚拟存储器却是为了解决主存容量。
   - Cache全由硬件实现，是硬件存储器，对所有程序员透明；而虚拟存储器由OS和硬件共同实现，是逻辑上的存储器，对系统程序员不透明，但对应用程序员透明。
   - 虚拟存储器系统不命中时对系统性能影响更大。
   - CPU与Cache和主存都建立了直接访问的通路，而辅存与CPU没有直接通路。也就是说在Cache不命中时主存能和CPU直接通信，同时将数据调入Cache；而虚拟存储器系统不命中时，只能先由硬盘调入主存，而不能直接和CPU通信。

##### 习题笔记

- 虚拟存储管理系统的基础是**程序访问的局部性原理**，此理论的基本含义是**在程序的执行过程中，程序对主存的访问是不均匀的**。

- **段页式和页式**交换的单位都是**页**。

- 虚拟存储器对应用程序员透明，对系统程序员不透明。

- 在虚拟存储器中，当程序正在执行时，由**操作系统**完成地址映射。

- 段式虚拟存储器中，段具有逻辑独立性，易于实现程序的编译、管理和保护，也便于多道程序共享。

- |          | 快表           | 慢表 |
  | -------- | -------------- | ---- |
  | 存储位置 | 高速缓冲器     | 内存 |
  | 速度     | 快             | 慢   |
  | 容量     | 小             | 大   |
  | 内容     | 只是慢表的副本 | 完整 |

- 缺页处理完成后回到发生缺页的指令继续执行。

- Cache由SRAM组成；TLB通常由相联存储器组成，也可由SRAM组成。

  TLB和Cache的共同特点：

  - 命中率都与程序局部性有关。
  - 缺失后都需要去访问主存。
  - 缺失处理都可以由硬件实现。

## 指令系统

### 指令格式

##### 指令的基本格式

- 指令的含义

  ![image-20220914210614810](计组.assets/image-20220914210614810.png)

- 指令的格式

  ![image-20220914210750922](计组.assets/image-20220914210750922.png)

- 按照地址码数目分类

  - 零地址指令

    ![image-20220914211225747](计组.assets/image-20220914211225747.png)

  - 一地址指令

    ![image-20220914211455408](计组.assets/image-20220914211455408.png)

  - 二、三地址指令

    ![image-20220914211800288](计组.assets/image-20220914211800288-17313146471684.png)

  - 四地址指令

    ![image-20220914211920200](计组.assets/image-20220914211920200.png)

  - 总结

    ![image-20230718195955493](计组.assets/image-20230718195955493.png)

- 按照指令长度分类

  ![image-20220914212415035](计组.assets/image-20220914212415035.png)

- 按照操作码长度分类

  ![image-20220914212602508](计组.assets/image-20220914212602508.png)

- 按照操作类型分类

  ![image-20220914212924809](计组.assets/image-20220914212924809.png)

##### 扩展操作码指令格式

![image-20220914213119267](计组.assets/image-20220914213119267.png)

- 扩展操作码举例

  ![image-20220914213317240](计组.assets/image-20220914213317240.png)

  ![image-20220914214120828](计组.assets/image-20220914214120828.png)

- 扩展操作码的规范

  ![image-20220914213459945](计组.assets/image-20220914213459945.png)

- 定长操作码与可扩展操作码对比

  ![image-20220914214340186](计组.assets/image-20220914214340186-17313146700235.png) 

##### 习题笔记

- 指令系统是计算机软/硬件的界面。
- 指令系统和机器语言是有关的。
- PC存放当前欲执行指令的地址，而指令的地址码字段则保存操作数地址。
- 运算型指令寻址的是操作数，而转移型指令寻址的是下次欲执行的指令的地址。
- 程序控制类指令的功能是**改变程序执行的顺序**，并使程序具有测试、分析、判断和循环执行的能力。
- 程序控制类指令主要包括无条件转移、有条件转移、子程序调用和返回指令、循环指令等。
- 堆栈计算机中，零地址指令的操作数来自**堆栈的栈顶和次栈顶单元。**
- 单字长指令可加快取指令的速度。
- 计算机按字节编制，指令的位数必须是8的倍数。

### 指令的寻址方式

##### 指令寻址和数据寻址

1. 指令寻址

   寻找下一条将要执行的指令地址。

   - 顺序寻址

     通过程序计数器PC加1（1个指令字长），自动形成下一条指令的地址。

     ![image-20220917222712428](计组.assets/image-20220917222712428.png)

   - 跳跃寻址

     通过转移类指令实现。

     ![image-20220917222942075](计组.assets/image-20220917222942075.png)

   每一条指令的执行都分为“取指令”、“执行指令”两个阶段。

2. 数据寻址

   寻找本条指令的数据地址。

   - 操作数类型

     ![image-20230718200022469](计组.assets/image-20230718200022469.png)

   - 地址码的构成

     寻址特征：采用哪一种方式进行寻址

     **通过寻址特征和形式地址求出有效地址**

     ![image-20230718200034686](计组.assets/image-20230718200034686.png)

     ![image-20220917224030533](计组.assets/image-20220917224030533.png)

##### 常见的数据寻址方式1

1. 直接寻址

   ![image-20230718200051382](计组.assets/image-20230718200051382.png)

2. 间接寻址

   ![image-20230718200101478](计组.assets/image-20230718200101478.png)

   一次间址的一条指令的执行：取指令 访存1次  执行指令 访存2次。暂不考虑存结果，共访存3次。

3. 寄存器寻址

   ![image-20230718200111217](计组.assets/image-20230718200111217.png)

4. 寄存器间接寻址

   ![image-20230718200121584](计组.assets/image-20230718200121584.png)

5. 隐含寻址

   ![image-20230718200131040](计组.assets/image-20230718200131040.png)

6. 立即寻址

   ![image-20230718200139604](计组.assets/image-20230718200139604.png)

7. 总结

   ![image-20230718200148406](计组.assets/image-20230718200148406.png)

##### 数据寻址2——偏移寻址

![image-20220917225510260](计组.assets/image-20220917225510260.png)

1. 基址寻址

   ![image-20220917232645384](计组.assets/image-20220917232645384.png)

   操作系统中的重定位寄存器就是基址寄存器。

   基址寻址的作用：

   ![image-20220917230513604](计组.assets/image-20220917230513604.png)

     每个程序运行之前CPU的基址寄存器的值都会修改为当前运行程序的起始存放地址，而这一信息通常存放在PCB。

2. 变址寻址

   ![image-20230718200204203](计组.assets/image-20230718200204203.png)

   ![image-20220917231913858](计组.assets/image-20220917231913858.png)

3. 相对寻址

   ![image-20220917232608327](计组.assets/image-20220917232608327-17313147117276.png)

   ![image-20220917232357149](计组.assets/image-20220917232357149.png)

4. 总结

   ![image-20230718200215835](计组.assets/image-20230718200215835.png)

   注意：取出当前指令后，PC会指向下一条指令，相对寻址是**相对于下一条指令的偏移。**

##### 数据寻址3——堆栈寻址

![image-20220917233803612](计组.assets/image-20220917233803612.png)

![image-20220917233934041](计组.assets/image-20220917233934041.png)

![image-20220917234017265](计组.assets/image-20220917234017265.png)

##### 习题笔记

- 指令系统中采用不同的寻址方式的目的是**缩短指令字长，扩大寻址空间，提高编程的灵活性**。

- 无条件转移指令（是指程序转移到新的地址后继续执行）的功能是将指令中的地址码送入**程序计数器（PC）**。

- 为了缩短指令中某个地址段的位数，最有效的方法是采取**寄存器寻址**，因为寄存器的数量较小，使用较少的位数即可全部表示。

- 简化地址结构的基本方法是尽量采用**隐地址**。

- **变址寻址**便于处理数组问题。

  |                        | 基址寻址                         | 变址寻址                         |
  | ---------------------- | -------------------------------- | -------------------------------- |
  | 有效地址               | EA=(BR)+A                        | EA=(IX)+A                        |
  | 访存次数               | 1                                | 1                                |
  | 寄存器内容             | 由操作系统或管理程序确定         | 由用户设定                       |
  | 程序执行过程中值可变否 | 不可变                           | 可变                             |
  | 特点                   | 有利于多道程序设计和编制浮动程序 | 有利于处理数组问题和编制循环程序 |

- 跳跃寻址通过转移类指令（如相对寻址）来实现，可用来实现程序的条件或无条件转移。

- 对按字寻址的机器，程序计数器和指令寄存器的位数分别取决于存储器的字数和指令字长。

- 转移指令、子程序调用与返回指令用于解决变动程序中指令执行次序的需求。

- 指令寄存器寻址和指令寄存器间接寻址所需的指令码长度最短，立即寻址，直接寻址，间接寻址方式的指令码长度最长

  寄存器寻址方式执行速度最快，间接寻址方式的执行速度最慢。

  若指令系统采用定长指令码格式，则立即寻址方式执行速度最快。若采用变长指令码格式时，寄存器寻址方式执行速度最快。
  
- ![image-20221109220955216](计组.assets/image-20221109220955216.png)

- ALU的宽度和机器字长都是一次计算的二进制位数。 

### 程序的机器级代码表示

##### x86汇编语言指令基础

1. 相关寄存器   

   ![image-20220920195803003](计组.assets/image-20220920195803003.png)

    ![image-20220920195924521](计组.assets/image-20220920195924521.png)

   ![image-20220920200004811](计组.assets/image-20220920200004811.png)

   例子

   ![image-20220920200215522](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20220920200215522.png)

2. 常用指令

   - 算数和逻辑运算指令

     destination：目的地（d 目的操作数）

     source：来源地（s 源操作数）

     算数运算指令

     ![image-20220920201210502](计组.assets/image-20220920201210502.png)

     ![image-20230726203622225](计组.assets/image-20230726203622225.png)

     **X86不允许两个操作数都来自于主存。**

     逻辑运算指令

     ![image-20220920201543769](计组.assets/image-20220920201543769.png)

     

   - mov指令

     ![image-20220920195531949](计组.assets/image-20220920195531949.png)

3. AT&T格式  vs Intel格式

   AT&T格式是Unix、L nux的常用格式

   Intel格式是Windows的常用格式

   ![image-20220920202744787](计组.assets/image-20220920202744787.png)

   ![image-20220920203422575](计组.assets/image-20220920203422575.png)

##### 过程调用的机器级表示

假设过程P（调用者）调用过程Q（被调用者），过程调用的执行步骤如下：

- P将入口参数（实参）放在Q能访问到的地方。
- P将返回地址存到待定的地方，然后将控制转移到Q。
- Q保存P的现场（通用寄存器的内容），并为自己的非静态局部变量分配空间。
- 执行过程Q。
- Q恢复P的现场，将返回结果放到P能访问到的地方，并释放局部变量所占空间。
- Q取出返回地址，将控制转移到P。

##### 选择语句的机器级表示

1.  无条件转移指令---jmp

   ![image-20220920212800872](计组.assets/image-20220920212800872.png)

2. 条件转移指令

   ![image-20220920212831481](计组.assets/image-20220920212831481.png)

   ![image-20220920212851829](计组.assets/image-20220920212851829.png)

   写汇编语言代码时，一般会以函数名作为“标号”，标注该函数指令的起始地址。
   
   ![image-20230726205403750](计组.assets/image-20230726205403750.png)

##### 循环语句的机器级表示

1. 用条件转移指令实现循环

   ![image-20220920214044301](计组.assets/image-20220920214044301.png)

2. 用loop指令实现循环

   ![image-20220920214503045](计组.assets/image-20220920214503045.png)

##### 习题笔记 

![image-20230817165233748](计组.assets/image-20230817165233748.png)

![image-20231028181133343](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20231028181133343.png)

两数相加寄存器变化：

OF（溢出标志位，over flag）： 没有溢出为0

SF（符号标志位，symbol flag）：看符号位

CF（进位标志位，carry flag）：sub⊕C      （做减法时sub为1，C作为进位输出）

ZF（零标志位，zero flag）相关指令执行后结果为0那么  ZF=1,结果不为0则 ZF=0；

### CISC和RISC

##### 基本含义

![image-20230718200301039](计组.assets/image-20230718200301039.png)

![image-20220920215129759](计组.assets/image-20220920215129759.png)

##### 两者比较

![image-20230718200312268](计组.assets/image-20230718200312268.png)

##### 习题笔记

- RISC一定采用流水线技术，CISC可以实现流水线技术。
- RISC机的兼容性不如CISC机。
- RISC的指令和数据按边界对齐存放。

## 中央处理器

### CPU的功能和基本结构

##### CPU的功能

- CPU的功能

  ![image-20230718200326294](计组.assets/image-20230718200326294.png)

- 运算器和控制器的功能

  ![image-20230718200335583](计组.assets/image-20230718200335583.png)

##### CPU的基本结构

- 运算器的基本结构

  ![image-20230718200352951](计组.assets/image-20230718200352951.png)

  ![image-20230718200407927](计组.assets/image-20230718200407927.png)

- 控制器的基本结构

  ![image-20230718200422696](计组.assets/image-20230718200422696.png)

- CPU的基本结构

  ![image-20230718200434106](计组.assets/image-20230718200434106.png)

![image-20220921174912767](计组.assets/image-20220921174912767.png)

##### 习题笔记

- 通用寄存器是可编程指定多种功能的寄存器。

- 条件转移指令执行时所依据的条件来自**标志寄存器**。需要对标志寄存器的内容进行测试，看是否满足转移条件。

- n位CPU中的n指的是数据总线线数，数据总线的位数与处理器的位数相同，它表示CPU一次能处理的数据的位数。

- 在CPU的寄存器中，**指令寄存器（IR）**对用户是透明的。汇编语言程序员可见的是**程序计数器（PC）**。

- PC与MAR位数相同。

- 在一条无条件跳转指令的指令周期内，PC的值被修改2次。

  取指周期结束后，PC值自动加1；执行周期中，PC值修改位要跳转到的地址，所以被修改两次。

- 指令寄存器的位数取决于**指令字长**。程序计数器的位数取决于**存储器的容量**。

- CPU中通用寄存器的位数取决于**机器字长**（计算机能直接处理的二进制位数，决定了计算机的运算精度），可以存放操作数和各种地址信息，但不能存放指令。

- 在计算机系统中表征程序和机器运行状态的部件是**程序状态字寄存器（PSW）**。

- 控制器的功能是取指令、分析指令和执行指令，并产生有关操作控制信号。

- 指令译码是对**指令的操作码字段**进行译码。

- 地址译码器位于存储器中。

- 间址周期（取操作数的有效地址）结束时，MDR的内容为**操作数地址**。

### 指令执行过程

##### 指令周期

![image-20230718200444750](计组.assets/image-20230718200444750.png)

![image-20220922175303591](计组.assets/image-20220922175303591.png)

- 指令周期流程

![image-20230718200455897](计组.assets/image-20230718200455897.png)

##### 指令周期的数据流

1. 取指周期

   ![image-20230718200513037](计组.assets/image-20230718200513037.png)

2. 间址周期

   ![image-20220922180059079](计组.assets/image-20220922180059079.png)

3. 执行周期

   执行周期的任务是根据IR中的指令字的操作码和操作数通过ALU操作产生执行结果。不同指令的执行周期操作不同，因此没有统一的数据流向。

4. 中断周期

   ![image-20230718200527200](计组.assets/image-20230718200527200.png)

##### 指令执行方案

![image-20230718200539874](计组.assets/image-20230718200539874.png)

##### 习题笔记

- 指令**总是根据程序计数器**从主存中取出，即使有转移指令，也是从PC中取出。

- 指令周期：CPU从主存中每取出并执行一条指令所需的全部时间。

  时钟周期：称为节拍或T周期，是CPU操作的最基本单位。

  机器周期（CPU周期）：完成一个基本操作的时间，一个机器周期包含若干时钟周期。

  存取周期：存储器进行两次独立的存储器操作（连续两次读或写操作）所需的最小间隔时间。

- 取指令操作是控制器**自动运行**的，控制器不需要得到相应的指令。

- 只有出现中断请求时才会进入中断周期，每个指令周期不一定都包含一个中断周期。

- 不同长度的指令，取指操作不同，例如，单字长指令、双字长指令。如果指令长度相同，取指操作相同。

- **控制器**可区分存储单元中存放的是指令还是数据。取指周期取出的是指令，执行周期取出的是数据。

- 指令字长和机器字长的长度没有任何关系。指令字长一般取字节或者存储字长的整数倍。

- 冯诺依曼计算机根据指令周期的不同阶段来区分从存储器取出的是指令还是数据，取指周期取出的是指令，执行周期取出的是数据。

### 数据通路的功能和基本结构

##### 数据通路的功能

![image-20230718200553610](计组.assets/image-20230718200553610.png)

数据通路上流经的部件包括ALU、通用寄存器、状态寄存器、异常和中断处理逻辑等。

数据通路中的数据流动路径由控制部件控制，控制部件根据每条指令功能的不同，生成对数据通路的控制信号。

##### 数据通路的基本结构

1. CPU内部单总线方式

   **内部总线**是指同一部件，如CPU内部连接各寄存器及运算部件之间的总线;

   **系统总线**是指同一台计算机系统的各部件，如CPU、内存、通道和各类l/O接口间互相连接的总线。

   ![image-20220923212645801](计组.assets/image-20220923212645801.png)

   - 例题

     - 取指周期

       ![image-20230718200611070](计组.assets/image-20230718200611070.png)

     - 间址周期

       ![image-20230718200632707](计组.assets/image-20230718200632707.png)

     - 执行周期 

       ![image-20230718200648154](计组.assets/image-20230718200648154.png)

   - 单总线的ALU需要配合暂存器使用

2. 专用数据通路

   - 取指周期

     ![image-20230718200700480](计组.assets/image-20230718200700480.png)

   - 例题

     - 第一问

       <img src="计组.assets/image-20220923221035302.png" alt="image-20220923221035302" style="zoom:67%;" />

       ![image-20230718200715782](计组.assets/image-20230718200715782.png)

     - 第二问

       ![image-20230718200724947](计组.assets/image-20230718200724947.png)

     - 第三问

       ![image-20230718200733574](计组.assets/image-20230718200733574.png)

     - 第四问

       ![image-20230718200742494](计组.assets/image-20230718200742494.png)

     - 第五问

       ![image-20230718200750134](计组.assets/image-20230718200750134.png)

     - 第六问

       ![image-20230718200756206](计组.assets/image-20230718200756206.png)

##### 习题笔记

- 在单总线的CPU中，ALU的一个输入端与总线相连，另一个输入端通过一个暂存器与总线相连，输出端需通过一个暂存器与总线相连。

- 采用CPU内部总线方式的数据通路：结构简单、实现容易、性能较低、存在较多的冲突现象。

  不采用CPU内部总线方式的数据通路：结构复杂、硬件量大、不易实现、性能高、基本不存在数据冲突现象。

- CPU的读/写控制信号的作用

  - 决定数据总线上的数据流方向 
  - 控制存储器操作的读/写类型
  - 控制流入、流出存储器信息的方向
  
- 数据通路上流经的部件包括：ALU、通用寄存器、状态寄存器、Cache、MMU、浮点运算逻辑、异常和终端处理逻辑等。数据通路由控制部件控制，控制部件根据每条指令功能的不同生成对数据通路的控制信号。

- ![image-20221108230948109](计组.assets/image-20221108230948109.png)

- ![image-20221108231040744](计组.assets/image-20221108231040744.png)

### 控制器的功能和工作原理

![image-20220925204511124](计组.assets/image-20220925204511124.png)

根据指令操作码、目前的机器周期、节拍信号、机器状态条件，即可确定现在这个节拍下应该发出哪些“微命令”

CU发出一个微命令，可完成对应微操作。如：微命令1使得$PC_{out}、MAR_{in}$有效。完成对应的微操作1(PC)-->MAR。

##### 控制器的结构和功能

![image-20230718200811542](计组.assets/image-20230718200811542.png)

##### 硬布线控制器

1. 硬布线控制单元图

   ![image-20220925205217295](计组.assets/image-20220925205217295.png)

   微程序控制信号由组合逻辑电路根据当前的指令码、状态和时序，即时产生。

2. 硬布线控制器的设计

   ![image-20220925210546151](计组.assets/image-20220925210546151.png)

3. 每个阶段的微操作序列

   ![image-20220925210513296](计组.assets/image-20220925210513296.png)

4. 安排微操作时序的原则

   - 取指周期

     ![image-20220925211150625](计组.assets/image-20220925211150625.png)

   - 间址周期

     ![image-20220925211226699](计组.assets/image-20220925211226699.png)

   - 执行周期

     ![image-20220925211424302](计组.assets/image-20220925211424302.png)

5. 组合逻辑设计

   ![image-20220925211618617](计组.assets/image-20220925211618617.png)

   硬布线控制器的特点：

   指令越多，设计和实现就越复杂，因此一般用于RISC（精简指令集系统）

   如果扩充一条新的指令，则控制器的设计就需要大改，因此扩充指令较困难。

   由于使用纯硬件实现控制，因此执行速度很快。微操作控制信号由组合逻辑电路即时产生。

   CPU的控制方式

   ![image-20230718200828418](计组.assets/image-20230718200828418.png)

##### 微程序控制器

1. 控制器的设计思路

   ![image-20230718200837055](计组.assets/image-20230718200837055.png)

2. 微程序控制器的设计思路

   ![image-20220925215143985](计组.assets/image-20220925215143985.png)

3. 微程序控制器的基本结构

   ![image-20220925215755816](计组.assets/image-20220925215755816.png)

   主存储器用于存放程序和数据，在CPU外部，用RAM实现；控制存储器（CM）用于存放微程序，在CPU内部，用ROM实现。

4. 微程序控制器的工作原理

   ![image-20220925221002226](计组.assets/image-20220925221002226.png)

   ![image-20220925221727026](计组.assets/image-20220925221727026.png)

   也可以说有n个微程序和n+1个微程序段。

5. 易混淆概念

   机器指令==微程序

   微程序由多个微指令组成

   微指令由多个微命令组成

   微命令是微操作的控制信号

   微操作是微命令的执行过程

   指令周期：从主存取出并执行一条机器指令所需的时间

   微周期（微指令周期）：从控制器存储器取出一条微指令并执行相应微操作所需的时间。

##### 微指令的设计

1. 微指令的格式

   相容性微命令：可以并行完成的微命令。

   互斥性微命令：不允许并行完成的微命令。

   ![image-20220925223247689](计组.assets/image-20220925223247689.png)

2. 微指令的编码方式

   微指令的编码方式又称为微指令的控制方式，它是指如何对微指令的控制字段进行编码，以形成控制信号。编码的目标是在保证速度的情况下，尽量缩短微指令字长。

   - 直接编码（直接控制方式）

     ![image-20220925223652377](计组.assets/image-20220925223652377.png)

   - 字段直接编码方式

     ![image-20220925224423673](计组.assets/image-20220925224423673.png)

     - 优点：可以缩短微指令字长。
     - 缺点：要通过译码电路后再发出微命令，因此比直接编码方式慢。

     ![image-20220925224558340](计组.assets/image-20220925224558340.png)

   - 字段间接编码方式

     ![image-20220925224834889](计组.assets/image-20220925224834889.png)

3. 微指令的地址形成方式

   ![image-20220925225249649](计组.assets/image-20220925225249649.png)

   下地址方式例题

   ![image-20230718200854390](计组.assets/image-20230718200854390.png)

##### 微程序控制单元的设计

设计步骤

![image-20220925231320326](计组.assets/image-20220925231320326.png)

取指周期

![image-20220925231417945](计组.assets/image-20220925231417945.png)

确定微指令格式

![image-20220925231508406](计组.assets/image-20220925231508406.png)

编写微指令码点

根据操作控制字段每一位代表的微操作命令，编写每一条微指令的码点。

> 微程序设计分类

![image-20220925230849554](计组.assets/image-20220925230849554.png)

> 硬布线与微程序的比较

![image-20220925231158178](计组.assets/image-20220925231158178.png)

 ![image-20220925231243203](计组.assets/image-20220925231243203.png)

##### 习题笔记

- 微操作控制信号的形成主要与**指令译码信号和时钟信号**有关。
- 在微程序控制器中，形成微程序入口地址的是**机器指令的操作码字段**。
- 微程序控制器的速度比硬布线控制器慢，主要是因为**增加了从控制存储器读取微指令的时间**。
- 与硬布线控制器相比，**微程序控制器的时序系统比较简单**。
- 微指令计数器决定的是微指令执行顺序。
- 一条水平型微指令能定义并执行几种并行的基本操作；一条垂直型微指令只能定义并执行一种基本操作。
- 水平型微指令能**充分利用数据通路的并行结构**。
- 若带中断指令系统中具有n种机器指令，则控制存储器中的微程序数至少是n+2个，一个是公共的取指令，另一个对应中断的微程序。
- 微机的CPU都是微处理器，和采用哪种控制器没有关系。
- 除控制部件（控制器）之外的部件都是执行部件。包括运算器、存储器、外围设备。
- 主存储器和控制存储器都**按地址访问，**主存由RAM和ROM实现，控制存储器由ROM实现。
- 时钟脉冲信号的宽度称为时钟周期，时钟周期是CPU工作的最小时间单位，时钟周期的倒数为机器主频。时钟脉冲信号是由机器脉冲源发出的脉冲信号经整形和分频后形成的，时钟周期以相邻状态单元间组合逻辑电路的最大延迟为基准确定。
- 汇编程序员可见的寄存器有基址寄存器、状态/标志寄存器、程序计数器PC和通用寄存器组。
- 控制存储器CM的容量是$2^{下地址字段位数}*微指令字长$。

### 指令流水线

##### 指令流水线的基本概念

1. 指令流水的定义  

   ![image-20230718200913337](计组.assets/image-20230718200913337.png)

   ![image-20230718200925103](计组.assets/image-20230718200925103.png)

2. 流水线的表示方法

   ![image-20230718200935526](计组.assets/image-20230718200935526.png)

##### 流水线的性能指标

- 吞吐率

  ![image-20230718200942855](计组.assets/image-20230718200942855.png)

- 加速比

  ![image-20230718200951286](计组.assets/image-20230718200951286.png)

- 效率

  ![image-20230718200959832](计组.assets/image-20230718200959832.png)


##### 影响流水线的因素及分类

1. 机器周期的设置

   ![image-20230718201012455](计组.assets/image-20230718201012455.png)

   理想情况下，每个机器周期（功能段）只消耗一个时钟周期。

2. 影响流水线的因素

   - 结构相关

     ![image-20230718201020638](计组.assets/image-20230718201020638.png)

   - 数据相关

     ![image-20230718201026961](计组.assets/image-20230718201026961.png)

     RAW（read after write）：写后读

     另外两个同上

     ![image-20230718201038236](计组.assets/image-20230718201038236.png)

   - 控制相关

     ![image-20220927203818552](计组.assets/image-20220927203818552.png)

   - 总结

     ![image-20230718201049142](计组.assets/image-20230718201049142.png)

3. 流水线的分类

   ![image-20230718201058767](计组.assets/image-20230718201058767.png)

   ![image-20230718201106220](计组.assets/image-20230718201106220.png)

##### 流水新的多发技术（高级流水线技术）

1. 超标量技术

   ![image-20230718201113984](计组.assets/image-20230718201113984.png)

2. 超流水技术

   ![image-20230718201122911](计组.assets/image-20230718201122911.png)

   流水线速度是原来速度的3倍。

3. 超长指令字技术

   ![image-20230718201132110](计组.assets/image-20230718201132110.png)

##### 五段式指令流水线

![image-20220927211805947](计组.assets/image-20220927211805947.png)

1. 运算类指令

   ![image-20220927212406266](计组.assets/image-20220927212406266.png)

2. LOAD指令、STORE指令

   ![image-20220927212815103](计组.assets/image-20220927212815103.png)

   ![image-20220927213242555](计组.assets/image-20220927213242555.png)

3. 条件转移指令

   ![image-20220927213705761](计组.assets/image-20220927213705761.png)

4. 无条件转移指令

   ![image-20220927214112360](计组.assets/image-20220927214112360.png)

5. 例题

   ![image-20220927214519067](计组.assets/image-20220927214519067.png)

![image-20221106214640313](计组.assets/image-20221106214640313.png)

##### 习题笔记

- RISC都采用流水线技术，提高资源利用率。CISC大部分采用流水线技术。
- 超标量流水线的实质是**以空间换时间**，不是指运算操作并行。
- 采用**旁路技术**可解决数据相关问题。在分支指令加入若干空操作可以**避免控制冒险**，通过编译器调整指令执行顺序可解决部分控制冒险。
- 流水线按序流动时，在RAW、WAR、WAW中，只可能出现RAW（写后读）相关。
- 超标量流水线不影响流水线功能段的处理时间。
- 流水线数据通路由控制部件控制，但不包含控制部件。
- 理想情况下，单周期CPU，基本流水线CPU的CPI为1，多周期CPU的CPI>1,超标量流水线CPU的CPI<1。
- 流水线采用“按序发射，按序完成”方式，下一条指令的IF（取指操作）必须和上一条指令的ID（译码）并行，以免因上一条指令发生冲突而导致下一条指令先执行完。

### 多处理器的基本概念

##### SISD、SIMD、MIMD的基本概念

1. SISD 单指令流单数据流结构

   特性：

   - 各指令序列只能并发、不能并行，每条  指令处理一两个数据
   - 不是数据级并行技术

   硬件组成：

   - 一个处理器+一个主存储器
   - 若采用指令流水线，需设置多个功能部件，采用多模块交叉存储器

2. SIMD 单指令流多数据流结构

   ![image-20220927220702528](计组.assets/image-20220927220702528.png)

3. MISD 多指令流单数据流结构

   多条指令并行执行，处理同一个数据。现实中不存在这种计算机。

4. MIMD 多指令流多数据流结构

   ![image-20220927220758399](计组.assets/image-20220927220758399.png)

5. 向量处理机（SIMD思想的进阶应用）

   ![image-20220927221024517](计组.assets/image-20220927221024517.png)

##### 硬件多线程的基本概念    

![image-20220927221854331](计组.assets/image-20220927221854331.png)

##### 多核处理器与共享内存多处理器基本概念

![image-20220927221144915](计组.assets/image-20220927221144915.png)

![image-20220927221312763](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20220927221312763.png)

##### 习题笔记

- 多处理机属于MIMD。
- 双核是指在CPU上集成两个运算核心。
- 超线程技术在CPU内部仅复制必要的线程资源，共享CPU的高速缓存和功能部件，让两个线程可以并行执行，模拟双核心CPU。
- 只有支持多线程的并行处理程序才能同时在多个核心上运行，发挥多核的优势。
- 多任务系统又称多道程序系统，可以运行在单核CPU上，宏观上并行，微观上串行。
- ![image-20221106220909002](计组.assets/image-20221106220909002.png)

## 总线

### 总线概述

![image-20220928155605249](计组.assets/image-20220928155605249.png)

##### 总线基本概念

![image-20230717163227886](计组.assets/image-20230717163227886.png)

- 总线特性

  ![image-20220928155934933](计组.assets/image-20220928155934933.png)

##### 总线的分类

![image-20230717163238546](计组.assets/image-20230717163238546.png)

- 按数据传输格式

  ![image-20220928163713657](计组.assets/image-20220928163713657.png)

- 按总线功能

  ![image-20230717163248677](计组.assets/image-20230717163248677.png)

##### 系统总线的结构

1. 单总线结构

   ![image-20230717163300107](计组.assets/image-20230717163300107.png)

2. 双总线结构

   ![image-20230717163309540](计组.assets/image-20230717163309540.png)

3. 三总线结构

   ![image-20230717163320346](计组.assets/image-20230717163320346.png)

4. 四总线结构简介（不考）

   ![image-20220928161852514](计组.assets/image-20220928161852514.png)

##### 总线的性能指标

![image-20220928162803040](计组.assets/image-20220928162803040.png)

![image-20220928162845518](计组.assets/image-20220928162845518.png)

- 例题

  ![image-20220928163316770](计组.assets/image-20220928163316770.png)

![image-20230717163335064](计组.assets/image-20230717163335064.png)

- 总结

![image-20230717163347633](计组.assets/image-20230717163347633.png)

##### 总线事务和定时

1. 总线传输的四个阶段

   ![image-20230717163400389](计组.assets/image-20230717163400389.png)

2. 同步定时方式

   ![image-20220928164837581](计组.assets/image-20220928164837581.png)

   ![image-20220207160831129](计组.assets/image-20220928165112514.png)

3. 异步定时方式

   ![image-20230717163417963](计组.assets/image-20230717163417963.png)

   ![image-20230717163429283](计组.assets/image-20230717163429283.png)

4. 半同步通信（拓展）

   ![image-20230717163438864](计组.assets/image-20230717163438864.png)

5. 分离式通信（拓展）

   ![image-20230717163454096](计组.assets/image-20230717163454096.png)

##### 习题笔记

- 总线上的部件，只能分时向总线发送数据，但可同时从总线接受数据。
- 在总线上，**同一时刻只能有一个主设备控制总线传输操作**。
- 使用总线结构便于增减外设，**同时减少信息传输线的条数**。
- 系统总线中地址线的功能是**指定主存和 I/O设备接口电路的地址**。
- 不同信号在同一条信号线上分时传输的方式称作**总线复用方式**。
- 主存通过**总线的类型**来识别信息是地址还是数据。地址在地址总线上传输，数据在数据总线上传输。
- CPU的控制总线提供的控制信号包括时序信号、控制信号和I/O设备和存储器的响应信号。
- PCI、EISA、ISA是并行总线；USB是通用串行总线。
- 高速设备采用局部总线技术的作用是**节省系统的总带宽**。
- 突发式（猝发式）发送可以连续传送地址连续的数据，提高总线数据传输率。
- USB是串行传输，不能同时传输2位数据； 可通过级联方式连接多台外设。
- 用于设备和设备控制器（I/O接口）之间互联的接口标准是**USB**。
- 靠近CPU的总线速度较快。多总线结构中，总线之间通过**桥接器**连接，起到流量交换的作用。
- PCI—Express采用串行数据包方式传送数据。
- 同步控制既可用于CPU控制，也可用于高速的外部设备控制。
- 同步控制方式适用于速度较为接近的两个设备；异步控制方式适用于速度相差很大的两个设备。
- 在异步总线中，传送操作**按需分配时间**。
- 同步总线由统一的时序信号控制，异步总线由握手信号定时。

## 输入输出系统

### *IO系统基本概念

![image-20220929202323995](计组.assets/image-20220929202323995.png)

> 主机如何与I/O设备进行交互？  

![image-20220929200446568](计组.assets/image-20220929200446568.png)

> CPU如何控制键盘I/O的完成？

![image-20220929200925699](计组.assets/image-20220929200925699.png)

   ![image-20220929201046620](计组.assets/image-20220929201046620.png)

![image-20220929201145680](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20220929201145680.png)

- DMA控制方式

  ![image-20220929201335136](计组.assets/image-20220929201335136.png)

  ![image-20220929201348836](计组.assets/image-20220929201348836.png)

  DMA控制器与主存每次传送1个字。当传送完一整块数据后才向CPU发出中断请求。

- 通道控制方式

  ![image-20220929201843653](计组.assets/image-20220929201843653.png)

##### I/O软件

![image-20220929202257183](计组.assets/image-20220929202257183.png)

##### 外部设备

![image-20220929202553357](计组.assets/image-20220929202553357.png)

- 输入设备

  ![image-20220929202616377](计组.assets/image-20220929202616377.png)

  ![image-20230712203214251](计组.assets/image-20230712203214251.png)

##### 习题笔记

- I/O指令是CPU系统指令的一部分，格式和其他通用指令相比有所不同。
- 通道程序放在主存中，由通道从主存中取出并执行，且只在具有通道的I/O系统中执行。
- 键盘，鼠标等输入设备一般都采用**中断方式**来实现。
- 打印机从打字原理的角度来分析，可分为击打式和非击打式；按能打出汉字来分，可分为点阵式打印机和活字式打印机。
- 计算机中一个汉字内码在主存中占用2B， 输出的字型码 16*16点阵在缓冲存储区中占用16×16/8=32B。

### I/O接口

##### I/O接口的功能

- 功能

  ![image-20230712203231592](计组.assets/image-20230712203231592.png)

  ![image-20220929211710955](C:\Users\13010\AppData\Roaming\Typora\typora-user-images\image-20220929211710955.png)

##### I/O接口的基本结构

![image-20230712204055342](计组.assets/image-20230712204055342.png)

##### I/O端口及其编址

![image-20230712204122713](计组.assets/image-20230712204122713.png)

状态端口和控制端口可以合用同一个寄存器。

![image-20220929211018135](计组.assets/image-20220929211018135.png)

##### I/O接口的类型

![image-20220929211210543](计组.assets/image-20220929211210543.png) 

##### 习题笔记

- 在统一编制方式下，区分存储单元和I/O设备是靠**不同的地址码**，进行输入/输出的操作指令是**访存指令**。
- I/O接口的功能也包括I/O过程中的错误和状态检测。
- 磁盘驱动器向盘片磁道记录数据时采用**串行方式**写入。
- 程序员进行系统调用访问设备使用的是**逻辑地址**。
- I/O指令实现的数据传送通常发生在**通用寄存器和I/O端口之间**。

### I/O方式

##### 程序查询方式

- 程序查询方式流程图

  ![image-20230712210330765](计组.assets/image-20230712210330765.png)

- 接口结构

  ![image-20230712210343783](计组.assets/image-20230712210343783.png)

- 例题

  ![image-20230712210359197](计组.assets/image-20230712210359197.png)

- 总结

  ![image-20230712210409922](计组.assets/image-20230712210409922.png)

  独占查询：CPU 100%的时间都在查询I/O状态，完全串行。

  定时查询：在保证数据不丢失的情况下，每隔一段时间CPU就查询一次I/O状态。查询的间隔内CPU可以执行其他程序。

##### 中断的作用和原理

1. 基本概念   

   ![image-20230712210424945](计组.assets/image-20230712210424945.png)

2. 分类

   ![image-20230712210437671](计组.assets/image-20230712210437671.png)

   关中断的作用：实现原子操作

   IF=1表示开中断（允许中断）;IF=0表示关中断（不允许中断）

3. 中断请求标记

   ![image-20230712210448749](计组.assets/image-20230712210448749.png)

4. 中断判优

   ![image-20230712210500868](计组.assets/image-20230712210500868.png)

5. 优先级设置

   ![image-20230712210510734](计组.assets/image-20230712210510734.png)

6. 中断处理过程

   ![image-20220930175753142](计组.assets/image-20220930175753142.png)

7. 中断隐指令

   ![image-20230712210522188](计组.assets/image-20230712210522188.png)

   中断隐指令并不是一条由程序员安排的真正的指令，只能在响应中断时由硬件直接控制执行。不在指令系统中，不属于程序控制指令。

8. 中断服务程序

   ![image-20220930180631678](计组.assets/image-20220930180631678.png)

9. 总结

   ![image-20220930181503771](计组.assets/image-20220930181503771.png)

##### 多重中断

<img src="计组.assets/image-20220930181642559.png" alt="image-20220930181642559" style="zoom:67%;" />

- 中断屏蔽技术

  ![image-20230712210538234](计组.assets/image-20230712210538234.png)

- 中断屏蔽技术 例题（重要，需掌握）

  ![image-20230712210549797](计组.assets/image-20230712210549797.png)

##### 程序中断方式

恢复现场即算做下一次启动

![image-20230712210606745](计组.assets/image-20230712210606745.png)

- 例题 第一问

  ![image-20220930183527918](计组.assets/image-20220930183527918.png)

- 例题 第二问 （重要）

  CPI：执行一条指令所需要的时钟周期

  ![image-20230712210618523](计组.assets/image-20230712210618523.png)

##### DMA方式

- DMA 控制器

  ![image-20220930184631823](计组.assets/image-20220930184631823.png)

- 结构

  ![image-20230712210634971](计组.assets/image-20230712210634971.png)

- DMA传送过程

  ![image-20220930185306984](计组.assets/image-20220930185306984.png)

- DMA传送方式

  ![image-20230712210648464](计组.assets/image-20230712210648464.png)

- DMA方式的特点

  ![image-20220930185604597](计组.assets/image-20220930185604597-17313150665737.png)

- DMA方式与中断方式对比

  ![image-20220930185925474](计组.assets/image-20220930185925474.png)

- 例题

  - CPU占用情况 中断方式

    ![image-20230712210807930](计组.assets/image-20230712210807930.png)

  - CPU占用情况 DMA方式

    ![image-20230712210752739](计组.assets/image-20230712210752739.png)

- 总结

  ![image-20230712210842410](计组.assets/image-20230712210842410.png)

##### 习题笔记

- 指令执行结果出现异常而引起的中断是**程序性中断（软件中断）**；主存故障引起的中断是**硬件中断**。

- 异常事件在当前指令执行过程中进行检测，中断请求在当前指令执行后进行检测。

- 自陷是通过陷阱指令预先设定的一类内部中断（异常）事件。CPU在执行完自陷指令后，自动根据不同陷阱类型进行相应的处理，然后返回到陷阱指令的下一条指令执行。当自陷指令是转移指令时，则返回到转移目标指令执行。

- ![image-20230712221905782](计组.assets/image-20230712221905782.png)

- 中断服务程序一般是操作系统模块，中断向量方法可提高中断源的识别速度。重叠处理中断的现象称为中断嵌套。

- 中断向量是中断服务程序的入口地址。中断向量地址是内存中存放中断向量的地址，即中断服务程序入口地址的地址。（重要）

- 可以提出中断的有外部事件（按Esc键退出运行的程序），虚拟存储器失效（缺页），浮点数运算上溢（溢出）。 浮点数运算下溢，直接当作机器零处理，不会引起中断。

- DMA的优先级比程序中断的优先级高；DMA方式不需要保护现场，中断请求是为了报告CPU数据的传输结束；程序中断方式需要保护现场，中断请求是为了传送数据。

- 中断服务程序的最后指令通常是**中断返回指令**，不仅要修改PC值还要将CPU中的所有寄存器都恢复到中断前的状态。

- 能产生DMA请求的总线部件是**具有DMA接口的设备**。

- **访管指令**优先级高于**外部中断**。

- 用户程序需要输入/输出时，需要调用操作系统提供的接口（请求操作系统服务），引起**访管中断**，系统由用户态转为核心态。

- 设置中断屏蔽标志可以**改变多个中断服务程序执行完的次序**。中断响应次序由硬件排队电路决定，与中断处理次序不同。

- 程序查询方式中，CPU与外设**串行**工作，传送与主程序**串行**工作。

  中断方式中，CPU与外设**并行**工作，传送与主程序**串行**工作。

  DMA方式中，CPU与外设**并行**工作，传送与主程序**并行**工作。

- CPU响应DMA请求的条件是当前**机器周期**执行完。

- DMA方式靠硬件电路实现。三种基本的程序控制方式即直接程序传送、程序中断、通道控制都需要程序的干预。

- 中断发生时，程序计数器内容的保护和更新是由**硬件自动完成**的。

- 在DMA方式下，数据从内存传送到外设经过的路径是内存-->数据总线-->DMAC（DMA的数据缓冲寄存器）-->外设。

- CPU响应中断后，需要保护中断的CPU现场，将PC和PSW压入堆栈，等中断结束后，就可以将压入堆栈的原PC和PSW的内容恢复到相应的寄存器，原程序从端点开始继续执行。中断隐指令：保护PC；中断服务程序：保护通用寄存器和状态寄存器。

- DMA传送前由**设备驱动程序**设置传送参数，传送结束后的处理由中断服务程序完成。

- 多重中断在保护被中断进程现场时关中断，执行中断处理程序时开中断。

- DMA中断是一整块传完中断一次，DMA请求是缓冲区冲满一次请求一次。

- CPU一般不采用程序查询方式与磁盘交换信息。

## 强化

##### 内存管理

- 对于大多数现代计算机体系结构，**PC 中保存的是虚拟地址**，而不是物理地址。在虚拟内存系统中，虚拟地址被转换成对应的物理地址，这个过程由操作系统中的内存管理单元（MMU）负责。在执行指令时，处理器会把虚拟地址送到 MMU，然后 MMU 根据页表等映射关系将虚拟地址转换成物理地址。

- PC在拥有MMU的情况下，其中存放的是虚拟地址，在无MMU平台中，其中存放的是物理地址。

  MAR中存放的是在物理内存中的真实地址。地址码部分不是虚拟地址，是形式地址，需要结合具体寻址方式来得到虚拟地址。若是直接寻址，那么地址码部分是虚拟地址。

- ![image-20230810133152929](计组.assets/image-20230810133152929.png)


##### 中央处理器

![image-20230819175608138](计组.assets/image-20230819175608138.png)

![image-20230819175620161](计组.assets/image-20230819175620161.png)

![image-20230819175632435](计组.assets/image-20230819175632435.png)

![image-20230819175726926](计组.assets/image-20230819175726926.png)

![image-20230819175744287](计组.assets/image-20230819175744287.png)
